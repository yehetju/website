<!DOCTYPE html>
<html>
  <head>
    <title>个人网站</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/common.css">
    <script src="./js/jquery-2.1.1.min.js"></script>
    <script src="./js/http.js"></script>
    <script src="./utils/base64decode.js"></script>
  </head>
  <body style="font-size: 14rem;">
    <div id="head" class="region">
      <div class="region-head">一人之下</div>
      <div id="english" class="region-content">正在加载....</div>
      <div id="chap"></div>
      <div id="chap-btn">
        <button type="button" class="btn btn-default" onclick="prev()">上一章</button>
        <button type="button" class="btn btn-default" onclick="category()">目录</button>
        <button type="button" class="btn btn-default" onclick="next()">下一章</button>
      </div>
      <script>
        var chapterList = [];
        var current = 0;
        http.jsonp({
          url: 'http://www.taduo.net/manhua/2/',
          encode: 'gb2312',
          success: function(res){
            let div = $('#english');
            var data = $(res).find('.plist');
            var chapters = data.find('a');
            var ul = $('<ul></ul>');
            chapters.each(function(i,item){
              let index = (chapters.length-i-1);
              chapterList.unshift({
                index: index,
                url: item.pathname,
                name: item.innerText
              });
              item.href = "javascript:goChap('" + item.pathname + "', "+index+")";
              ul.append($('<li></li>').append(item))
            })
            div.html('')
            div.append(ul);
            if(localStorage['cur']){
              var record = JSON.parse(localStorage['cur']);
              goChap(record.url, record.index);
            }
          }
        })
        function goChap(url, index){
          current = index;
          let div = $('#chap');
          div.html('');
          // 改变标题
          $('.region-head').html('一人之下：'+chapterList[index].name);
          http.jsonp({
            url: 'http://m.taduo.net' + url,
            success: function(res){
              $('#english').hide();
              $('#chap').show();
              $('#chap-btn').show();
              
              var reg_g = /cp="(.+?)"/g
              var result = reg_g.exec(res);
              var data = result[1];
              // 解析数据，获得packedarr
              eval(eval(base64decode(data).slice(4)));   
              var images = packedarr;
              for(var i in images){
                if(images[i].indexOf('/c8.jpg')>-1) continue;
                div.append('<img src="http://mh.jiduo.cc/' + images[i] + '" width="100%">');
              }
              // 记录当前进度
              localStorage['cur'] = JSON.stringify(chapterList[current]);
            }
          })
        }
        
        function next(){
          var next = chapterList[current+1];
          goChap(next.url, current+1);
        }
        function prev(){
          var next = chapterList[current-1];
          goChap(next.url, current-1);
        }
        function category(){
          $('#english').show();
          $('#chap').hide();
          $('#chap-btn').hide();
        }
        category()
      </script>
    </div>
    <style>
      .region{
        margin-top: 0;
      }
      #english ul{
        
      }
      #english li{
        list-style:none; /* 将默认的列表符号去掉 */
        float: left; /* 往左浮动 */
        display: block;
        padding: 10px 20px;
      }
      #chap-btn {
        text-align: center;
        padding: 20px;
      }
    </style>
	</body>
</html>
